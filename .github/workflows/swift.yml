# --------------------------------------------------------------------
# Auto Build & Release ClipCache
#
# This GitHub Actions workflow implements a professional indie-mac-dev
# release pipeline (Versioning Method: "Level 2 — Commit Version Bump")
#
# What this workflow does:
#
# 1. Detects the latest Git tag (e.g. v1.2.3)
# 2. Automatically increments the PATCH version (→ v1.2.4)
# 3. Updates Info.plist:
#      - CFBundleShortVersionString = 1.2.4
#      - CFBundleVersion = unix timestamp (build number)
# 4. Commits the updated Info.plist back to the main branch
# 5. Creates and pushes a new Git tag "v1.2.4"
# 6. Builds the macOS Release version of ClipCache using Xcode
# 7. Packages the .app into a .zip file
# 8. Creates a GitHub Release for the new version
# 9. Uploads the built .zip as a release asset
#
# Benefits of this workflow:
# - Your repo always reflects the exact version your users download
# - Local builds stay in sync after a git pull
# - Fully automated semantic version handling (patch bump)
# - Clean and predictable release history
# - Bar none, the most common setup used by professional indie mac devs
#
# After each release:
# - A version-bump commit appears in history
# - A new GitHub Release is published automatically
# - You only need to `git pull` locally when continuing development
#
# --------------------------------------------------------------------

name: Auto Build & Release ClipCache

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: macos-26

    steps:
      # -----------------------------
      # 0. Checkout repo with full history
      # -----------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      # 1. Get the latest version tag
      # -----------------------------
      - name: Get latest tag
        id: get_tag
        run: |
          tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "Latest tag: $tag"

      # -----------------------------
      # 2. Auto-increment PATCH version
      # -----------------------------
      - name: Bump patch version
        id: bump
        run: |
          ver="${{ steps.get_tag.outputs.tag }}"
          ver="${ver#v}"  # remove leading v
          IFS='.' read -r major minor patch <<< "$ver"
          patch=$((patch+1))
          new="v$major.$minor.$patch"
          echo "new_tag=$new" >> $GITHUB_OUTPUT
          echo "Bumping version to: $new"

      # -----------------------------
      # 3. Update Info.plist with new version
      # -----------------------------
      - name: Update Xcode Version (Info.plist)
        run: |
          ver=${{ steps.bump.outputs.new_tag }}
          pure="${ver#v}"  # convert v1.2.4 → 1.2.4

          plist="ClipCache/Info.plist"
          echo "Updating $plist to version $pure"

          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $pure" "$plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $(date +%s)" "$plist"

      # -----------------------------
      # 4. Commit version bump back to main
      # -----------------------------
      - name: Commit & push version bump
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add ClipCache/Info.plist
          git commit -m "Bump version to ${{ steps.bump.outputs.new_tag }}"
          git push origin main

      # -----------------------------
      # 5. Create & push the new Git tag
      # -----------------------------
      - name: Create and push tag
        run: |
          git tag ${{ steps.bump.outputs.new_tag }}
          git push origin ${{ steps.bump.outputs.new_tag }}

      # -----------------------------
      # 6. Build the Release .app
      # -----------------------------
      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode.app

      - name: Build Release
        run: |
          xcodebuild \
            -scheme "ClipCache" \
            -configuration Release \
            -derivedDataPath build

      # -----------------------------
      # 7. Package the app as a .zip
      # -----------------------------
      - name: Package .app
        run: |
          APP_PATH=$(find build -type d -name "*.app" | head -n 1)
          mkdir release
          cp -R "$APP_PATH" release/
          cd release
          zip -r ClipCache.zip *.app

      # -----------------------------
      # 8. Publish GitHub Release + upload asset
      # -----------------------------
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.bump.outputs.new_tag }}
          name: ${{ steps.bump.outputs.new_tag }}
          files: release/ClipCache.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
